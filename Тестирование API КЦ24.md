# Тестирование API КЦ24

## Сценарий тестирования

Проведено тестирование текущей версии API КЦ24 по следующему сценарию:

1. Отправка данных для рассылки
2. Проверка статуса сообщений

### Отправка данных для рассылки

Отправка осуществлялась запросом POST на адрес https://api-notify.callcenter24.ru/v1/message

   **Ожидаемый результат:**
   1. Ответ об успешном приеме данных
   2. Рассылка по указанным контактам, согласно правилам каскадной рассылки

   **Фактический результат:**
   1. Получен ответ от сервиса об успешном приеме данных:

      <u>Запрос 1:</u>
      ```
      POST https://api-notify.callcenter24.ru/v1/message
      ```

      ```json
      {
        "items": [
          {
            "projectId": "6555cf67fa7347e10604f7d4",
            "clientId": "10",
            "phones": [
              "89994954689",
              "89117775243"
            ],
            "content": {
              "template": "Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
              "variables": [
                {
                  "name": "name",
                  "value": "Дмитрий"
                }
              ]
            }
          }
        ]
      }
      ```

      <u>Ответ 1:</u>
      ```json
      {
        "success": true,
        "data": [
          {
            "_id": {
              "$oid": "65771d6554618a3657034d68"
            },
            "projectId": "6555cf67fa7347e10604f7d4",
            "clientId": "10",
            "phones": [
              "89994954689",
              "89117775243"
            ],
            "emails": null,
            "content": {
              "template": "Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
              "variables": [
                {
                  "name": "name",
                  "value": "Дмитрий"
                }
              ]
            },
            "transport": null,
            "status": null,
            "created_by": "65438d15fda91919923ef5ac",
            "created_at": {
              "$date": {
                "$numberLong": "1702305125374"
               }
            },
            "updated_by": "65438d15fda91919923ef5ac",
            "updated_at": {
              "$date": {
                "$numberLong": "1702305125374"
              }
            },
            "jobs": 5
          }
        ]
      }
      ```

      <u>Запрос 2:</u>
      ```
      POST https://api-notify.callcenter24.ru/v1/message
      ```

      ```json
      {
        "items": [
          {
            "projectId": "6555cf67fa7347e10604f7d4",
            "clientId": "11",
            "phones": [
              "79166649616",
            ],
            "content": {
              "template": "{{name}}, Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
              "variables": [
                {
                  "name": "name",
                  "value": "Фидель"
                }
              ]
            }
          }
        ]
      }
      ```

      <u>Ответ 2:</u>
      ```json
      {
        "success": true,
        "data": [
          {
            "_id": {
              "$oid": "6577256000c0cf9b630b3ade"
            },
            "projectId": "6555cf67fa7347e10604f7d4",
            "clientId": "11",
            "phones": [
              "79166649616"
            ],
            "emails": null,
            "content": {
              "template": "{{name}}, Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
              "variables": [
                {
                  "name": "name",
                  "value": "Фидель"
                }
              ]
            },
            "transport": null,
            "status": null,
            "created_by": "65438d15fda91919923ef5ac",
            "created_at": {
              "$date": {
                "$numberLong": "1702307168868"
               }
            },
            "updated_by": "65438d15fda91919923ef5ac",
            "updated_at": {
              "$date": {
                "$numberLong": "1702307168868"
              }
            },
            "jobs": 5
          }
        ]
      }
      ```

   2. Осуществлена рассылка по указанным контактам, согласно правилам каскадной рассылким

### Проверка статуса сообщений

Проверка осуществлялась запросом GET на адрес https://api-notify.callcenter24.ru/v1/message

   **Ожидаемый результат:**
   1. Получение подробной информации по статусам отправки по каждому указанному контакту (как минимум до первой успешной доставки)

   **Фактический результат:**
   1. Получен ответ от сервиса по статусу только успешной/неуспешной отправки (код статуса и массив со статусными сообщениями):

      <u>Запрос 1:</u>
      ```
      GET https://api-notify.callcenter24.ru/v1/message/65771d6554618a3657034d68
      ```

      <u>Ответ 1:</u>
      ```json
      {
        "success": true,
        "data": {
          "_id": "65771d6554618a3657034d68",
          "projectId": "6555cf67fa7347e10604f7d4",
          "clientId": "10",
          "phones": [
            "89994954689",
            "89117775243"
          ],
          "content": {
            "template": "Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
            "variables": [
              {
                "name": "name",
                "value": "Дмитрий"
              }
            ]
          },
          "created_at": "1702305125374",
          "status": {
            "id": 1,
            "details": [
              "{\"id\":1181240,\"cnt\":2}"
            ]
          }
        }
      }
      ```

      <u>Запрос 2:</u>
      ```
      GET https://api-notify.callcenter24.ru/v1/message/6577256000c0cf9b630b3ade
      ```

      <u>Ответ 2:</u>
      ```json
      {
        "success": true,
        "data": {
          "_id": "6577256000c0cf9b630b3ade",
          "projectId": "6555cf67fa7347e10604f7d4",
          "clientId": "11",
          "phones": [
            "79166649616"
          ],
          "content": {
            "template": "{{name}}, Ваш рейс 5N-9999 Анк-Морпорк - Барад-дур 07.12.2023 перенесен на 10:15 08.12.2023. Приносим свои извинения за доставленные неудобства. Колл-центр +74959700055.",
            "variables": [
              {
                "name": "name",
                "value": "Фидель"
              }
            ]
          },
          "created_at": "1702307168868",
          "status": {
            "id": 1,
            "details": [
              "{\"error_code\":8,\"error\":\"can't to deliver\"}",
              "{\"id\":1181870,\"cnt\":1}"
            ]
          }
        }
      }
      ```

## Итог

Отправка при небольшой интенсивности осуществляется корректно, согласно правилам касакдной рассылки.

Информативность статусов доставки сообщений оставляет желать лучшего. Со стороны КЦ24 обещано в ближайшее время добавить детализации (расшифровку статусов и сервисов, которые их возвращают).